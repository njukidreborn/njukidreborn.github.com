---
layout: post
title: 智能家居实践
category: Home
status: publish
published: true
type: post
keywords:
  - Smart Home
  - Homekit
  - Home Assistant
  - Alex
  - Google Home
---

一直计划录一个视频详细讲解一下最近一年在家使用智能家居的心得感受，尤其是平台 [Home Assistant](https://www.home-assistant.io) 的优劣。没曾想最近几天我家的 Home Assistant 问题频出，在 troubleshooting 的过程中对智能家居平台的现状有了新的体会，原本录好一半的视频只能放弃，择日重录了。

视频虽然鸽了，但不妨碍我先写一篇文章，介绍一下我家里智能家居配置的现状，给感兴趣的朋友一个参考。

## 主控

我家里先后拥有了 Alexa 智能音箱（16年跟朋友一起团购的），Google Home Mini （Google 送的）以及 iOS 设备，所以这三个主流的智能主控我都能用。但因为它们各自支持的设备都较为有限，所以我更多是将它们和智能设备进行搭配组合，尽可能地保证我能够同时用手机应用以及语音来控制附近的设备。

与此同时我也使用 Home Assistant 作为我的本地主控中心。Home Assistant 的优点是主动本地控制（不经过云端），而且是开源的，几乎能够支持所有的智能设备，甚至广义上的 IOT 设备，基本一个设备能够接入到局域网，就很有可能被 Home Assistant 支持。更多关于 Home Assistant 的优缺点，我会在之后的视频中详细分析。

同时为了能够让家人也轻松地控制所有的设备，我使用 Home Assistant 的 Homekit integration 以及跑在 NAS 上的 Homebridge，将设备开放给 Homekit。家人可以通过他们的苹果设备和 Siri 来进行操控。

具体来说：

- 两个 Amazon Echo 用于语音控制厨房和车库的设备
- Google Home Mini 用于管理书房的设备
- Home Assistant 用于连接管理各种通用或者“狭义”的智能设备，以及处理自动化和设备联动
- 最后，家中所有人都可以通过苹果设备访问设备

*Home Assistant UI*

<img width="1516" alt="image" src="https://user-images.githubusercontent.com/876920/105220774-07e3bc80-5b0d-11eb-9940-a1ba61ecaf3e.png">

*Homekit (macOS)*

<img width="1648" alt="image" src="https://user-images.githubusercontent.com/876920/105220823-1d58e680-5b0d-11eb-82ac-3aa00a7263b5.png">

就使用体验来说

* Home Assistant 相应速度最快，无论是操控还是联动，几乎实时。也支持把设备暴露给 Homekit，但就我的使用环境下，homekit integration 有一个 bug，经常不稳定。
* Homebridge on NAS，这是为了解决 Home Assistant 无法连接 Homekit 而用的替代方案，优点是稳定，缺点是本身没有自动化
* Homekit 通过手机操作时也是实时的，完美。一旦用到 Siri，那就是三四秒开外了，从手表上操控的话，再加两秒。
* Google Home 和 Alexa 半斤八两，无法操控设备或者超时时有发生

## 协议

老实说，我在选择协议上犯了很大的错误。一开始由于对协议不算了解，我倾向于购买使用 Wifi 和 Bluetooth 的设备，因为它们的连接最方便，购买上的选择也足够多。

如果让我再选一次，我有可能会选择 zwave，不仅是 mesh 网络，而且不在 2.4GHz频段上。不过也只是有可能，因为相比 zwave，我还是更喜欢 zigbee 这样开放的平台。

## 设备

在挑选设备的时候，我的主要原则是稳定性和质量，价格和平台支持则是次要的。当然像黑五遇到五美金一个的 Amazon 私有的插座，买不了吃亏买不了上当，就另当别论了。

我家里设备及具体用法是：

- 三组宜家的智能灯。
    - 每组智能灯有一个灯泡和一个小遥控器用于调控色温和亮度。如果家里有婴儿的话，很多时候语音和手机控制都不方便，遥控器要实用很多。此外，闺女两岁左右就可以自己用遥控器开关灯了，从此“不求人”。
- TP Link Kasa 的开关，室内、室外插座若干
    - 家里的绝大多数顶灯和落地灯都是它们控制的。如果没有调节灯的亮度或者颜色的需求，智能开关体验好非常多。
- 飞利浦 Hue 的智能灯
    - 全部用在书房了。长时间工作用的灯，亮度和质量的标准都要高一些。
- Hue 和 Aqara 的 Hub，可以将来用于管理 zigbee 设备。
- Aqara 的 门窗传感器，Wyze 的门窗传感器、摄像头。
    - 用来监控家里的门窗和车库门有没有关上，出门或者晚上忘了关车库门这种事发生了好几次了，只能说小区还算安全吧。
- Aqara 的 Motion Sensor，用于晚上检测人的走动。
- NFC 标签，用于搭配 Homekit 使用。
- Airthings 的空气质量检测。
- 多个品牌的插座
- 其他“广义”的智能设备。因为使用了 Home Assistant，所以电视机、树莓派、NAS、打印机都能被接入到平台中。当然这也是前人栽树，后人乘凉，这些设备本身就使用了 UPnP，IPP 之类的。这是我愿意选择 Home Assistant 的原因，通用的平台才是好平台。

## 自动化、联动

在处理自动化脚本和设备间联动上，我优先使用 Home Assistant，在响应速度、稳定性上都完胜。在需要针对个人进行定制的地方，则主要使用 Homekit Automation 和 Siri Shortcut。

- 最受家中领导赞赏的是：打开进入车库的门时自动把车库顶灯打开，两分钟后自动关闭。
- 我最喜欢的是每天天黑前半小时，自动打开 Driveway 和户外的装饰灯，天亮前关了。以往都是我们手动开关，自动化之后才发现每天都少一桩事太爽了。
- 当使用开关打开车库的顶灯时，同时打开其他所有的灯。车库的顶灯不够多，使用智能开关和插座的联动是最便宜的改造方式。
- 晚上定时检查所有门窗、车库门是否关闭，未关闭则发送通知。
- 晚上如果有人走下楼梯，自动打开楼下的灯。
- 有人回到家就打开车库的灯，五分钟后关闭。住在郊区，所以出门肯定是开车，前门基本就是用来收快递的。
- 当所有人都离开家后，打开 Alarm System，关闭其他所有的灯。
- 每当有门窗开关，手机发送通知
    - 以上都是通过 Homekit 来实现的，手机与人是一对一关系，很好处理。
- 家里有小孩，语音有时候不方便，于是在顺手的位置贴上 NFC 标签，手机一扫就可以开关设备或者执行自动化脚本。

跟很多智能家居爱好者相比，我用的自动化非常少。这不见得是坏事，它可能代表着家里的设计本身比较宜居。就拿开关灯来说，如果开关都在顺手的位置，动静检测触发开关有“多此一举”之嫌。不过使用智能设备进行联动，是一种价格低廉的 remodel 替代方案（仅限北美）。

![image](https://user-images.githubusercontent.com/876920/105223778-146a1400-5b11-11eb-8cd4-17d985d49017.png)


## 自定义场景

除了自动化，我也设置了几个场景，一键控制多个不同的设备状态：

- 工作，打开书房所有的灯，设置色温为 4000K。
- 阅读，同上，色温改为 3000K。
- 晚安，关掉除前院 driveway 上的所有的灯。
- Youtube Time。打开电视并切换到 Youtube 应用，同时打开客厅的灯。
- Apple TV。同上，电视源切换至连接到 Apple TV 的 HDMI。

## 意料之外的升级

就像你上面看到的，我对智能家居的使用还是很初级的，主要是用自动化取代一些每天都要手动执行的工作。讲的好听点叫做“渐进式的升级”，但我觉得认真分析需求是有必要的，真正解决自己的痛点才有意义。

虽然只是增加了一点点 Smartness，但这些设备却给我本身的生活带来了意想不到的麻烦，而这些在选购智能设备时很容易被忽视。当只有一两个设备时，大家都相安无事。但当我趁着 Prime Day 购买不同品牌、不同协议的设备，设备数量达到了两位数后，信号干扰开始成问题了。Wifi 类的智能设备都是使用 2.4GHz 频段，同时 Homekit 使用 mDNS/Bonjour，对路由器是个挑战。好一点的路由器都会对 mDNS/Bonjour 进行优化，但优化的同时又带来了更多的 bug，导致设备常常断开连接。更麻烦的是，2.4 GHz 上还有 Zigbee 和 Bluetooth，在 PC 上使用 MX Master 3 时就经常遇到蓝牙信号干扰的问题。

我住的是 90 年代的老房子，屋内只有 Coax 而没有网线，但是我又不看传统的电视，所以家里的网络基础架构就是 `Coax -> Modem -> Router` ，一个路由器覆盖 300 平米。路由器放在客厅，从物理位置上来说很靠近家的正中心，所以客厅里的速度能够达到 250 Mbps (我们家选择的网络带宽理论上限)，而二楼角落里也能够有 100 Mbps，所以用了四年也从未考虑过升级，甚至去年一年都在家办公都没有大的需求要改善网络。直到有了这些智能设备，当我在书房办公室，如果 PC 使用 5 GHz 信道，因为信号穿了两道墙，衰减有点严重，而如果使用 2.4 GHz，又会显著增加对蓝牙信号的干扰。

权衡利弊，最后我购买了 MoCA 来使用 Coax 传输网络数据，基本能够达到 1Gbps，搭配 gbe switch 就能够使用将支持 ethernet 的设备连入到有线网中，减少无线网络的压力。考虑到无论是 PC、电视还是 NAS，都只支持 gbe ，将来的很长一段时间都不需要升级网络设备了。

---

以上就是现阶段我对智能家居的使用，总体而言对全家的生活质量都有提高。不过也给我个人带来一些烦恼，主要在于让这些设备正常工作。即使是2021，智能家居设备们也不是即插即用，任重道远。